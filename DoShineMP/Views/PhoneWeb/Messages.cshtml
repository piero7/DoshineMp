
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section styles{
    <link href="~/Styles/Messages.css" rel="stylesheet" />
    <style type="text/css">
        #myModal {
            padding-top: 30%;
            z-index: 99999;
        }
    </style>
}

@*信息展示*@
<div id="bk"></div>
<div class="col-xs-12" id="bodycontent">
    <div class="jumbotron" id="messages" style="padding-bottom:60px;">
    </div>
</div>

@*信息输入*@
<div class="bg-input" id="foottext">
    <div class="input-in">
        <a class="imgBtn" href="javascript:void(0);"></a>
        <div  contenteditable="true" class="sendInput Input_text" id="sendText" placeholder="请输入内容..."></div>
        <span class="sendSpan text-center">
            <input class="sendBtn" onclick="send()" id="btnSend" type="button" value="发送" />
        </span>
    </div>
    <div class="faceDiv"> </div>
</div>

@*<input type="hidden" id="username" value="@ViewBag.user.NickName" />
    <input type="hidden" id="userid" value="@ViewBag.user.UserInfo.UserInfoId" />
    <input type="hidden" id="userimg" value="@ViewBag.user.Headimgurl" />
    <input type="hidden" id="openid" value="@ViewBag.user.OpenId" />*@
<input type="hidden" id="welcome" value="@ViewBag.welcome" />




<!-- Modal 模态框 -->
<div class="modal fade in" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="form-group">
                    @*<label for="exampleInputEmail1">手机号</label>*@
                    <input type="text" class="form-control" id="exampleInputPhone" placeholder="请输入手机号或邮箱">
                </div>
                <div class="form-group">
                    @*<label for="exampleInputPassword1">电子邮箱</label>*@
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" id="quxiao">取消</button>
                <button type="button" class="btn btn-primary" id="queren">确认</button>
            </div>
        </div>
    </div>
</div>


@section scripts{
    <script src="~/Scripts/Models.js"></script>


   




    <script type="text/javascript">
        var Src = '';
        $(document).ready(function (e) {
            ImgIputHandler.Init();
        });
        var ImgIputHandler = {
            facePath: [
                { faceName: "微笑", facePath: "0_微笑.gif" },
                { faceName: "撇嘴", facePath: "1_撇嘴.gif" },
                { faceName: "色", facePath: "2_色.gif" },
                { faceName: "发呆", facePath: "3_发呆.gif" },
                { faceName: "得意", facePath: "4_得意.gif" },
                { faceName: "流泪", facePath: "5_流泪.gif" },
                { faceName: "害羞", facePath: "6_害羞.gif" },
                { faceName: "闭嘴", facePath: "7_闭嘴.gif" },
                { faceName: "大哭", facePath: "9_大哭.gif" },
                { faceName: "尴尬", facePath: "10_尴尬.gif" },
                { faceName: "发怒", facePath: "11_发怒.gif" },
                { faceName: "调皮", facePath: "12_调皮.gif" },
                { faceName: "龇牙", facePath: "13_龇牙.gif" },
                { faceName: "惊讶", facePath: "14_惊讶.gif" },
                { faceName: "难过", facePath: "15_难过.gif" },
                { faceName: "酷", facePath: "16_酷.gif" },
                { faceName: "冷汗", facePath: "17_冷汗.gif" },
                { faceName: "抓狂", facePath: "18_抓狂.gif" },
                { faceName: "吐", facePath: "19_吐.gif" },
                { faceName: "偷笑", facePath: "20_偷笑.gif" },
                { faceName: "可爱", facePath: "21_可爱.gif" },
                { faceName: "白眼", facePath: "22_白眼.gif" },
                { faceName: "傲慢", facePath: "23_傲慢.gif" },
                { faceName: "饥饿", facePath: "24_饥饿.gif" },
                { faceName: "困", facePath: "25_困.gif" },
                { faceName: "惊恐", facePath: "26_惊恐.gif" },
                { faceName: "流汗", facePath: "27_流汗.gif" },
                { faceName: "憨笑", facePath: "28_憨笑.gif" },
                { faceName: "大兵", facePath: "29_大兵.gif" },
                { faceName: "奋斗", facePath: "30_奋斗.gif" },
                { faceName: "咒骂", facePath: "31_咒骂.gif" },
                { faceName: "疑问", facePath: "32_疑问.gif" },
                { faceName: "嘘", facePath: "33_嘘.gif" },
                { faceName: "晕", facePath: "34_晕.gif" },
                { faceName: "折磨", facePath: "35_折磨.gif" },
                { faceName: "衰", facePath: "36_衰.gif" },
                { faceName: "骷髅", facePath: "37_骷髅.gif" },
                { faceName: "敲打", facePath: "38_敲打.gif" },
                { faceName: "再见", facePath: "39_再见.gif" },
                { faceName: "擦汗", facePath: "40_擦汗.gif" },

                { faceName: "抠鼻", facePath: "41_抠鼻.gif" },
                { faceName: "鼓掌", facePath: "42_鼓掌.gif" },
                { faceName: "糗大了", facePath: "43_糗大了.gif" },
                { faceName: "坏笑", facePath: "44_坏笑.gif" },
                { faceName: "左哼哼", facePath: "45_左哼哼.gif" },
                { faceName: "右哼哼", facePath: "46_右哼哼.gif" },
                { faceName: "哈欠", facePath: "47_哈欠.gif" },
                { faceName: "鄙视", facePath: "48_鄙视.gif" },
                { faceName: "委屈", facePath: "49_委屈.gif" },
                { faceName: "快哭了", facePath: "50_快哭了.gif" },
                { faceName: "阴险", facePath: "51_阴险.gif" },
                { faceName: "亲亲", facePath: "52_亲亲.gif" },
                { faceName: "吓", facePath: "53_吓.gif" },
                { faceName: "可怜", facePath: "54_可怜.gif" },
                { faceName: "菜刀", facePath: "55_菜刀.gif" },
                { faceName: "西瓜", facePath: "56_西瓜.gif" },
                { faceName: "啤酒", facePath: "57_啤酒.gif" },
                { faceName: "篮球", facePath: "58_篮球.gif" },
                { faceName: "乒乓", facePath: "59_乒乓.gif" },
                { faceName: "拥抱", facePath: "78_拥抱.gif" },
                { faceName: "握手", facePath: "81_握手.gif" },
                { faceName: "得意地笑", facePath: "得意地笑.gif" },
                { faceName: "听音乐", facePath: "听音乐.gif" }
            ]
            ,
            Init: function () {
                var isShowImg = false;
                $(this).css('background-position', '0 -40px')
                $(".Input_text").focusout(function () {
                    $(this).parent().css("border-color", "#cccccc");
                    $(this).parent().css("box-shadow", "none");
                    $(this).parent().css("-moz-box-shadow", "none");
                    $(this).parent().css("-webkit-box-shadow", "none");
                });
                $(".Input_text").focus(function () {
                    $(this).parent().css("border-color", "rgba(19,105,172,.75)");
                    $(this).parent().css("box-shadow", "0 0 3px rgba(19,105,192,.5)");
                    $(this).parent().css("-moz-box-shadow", "0 0 3px rgba(241,39,232,.5)");
                    $(this).parent().css("-webkit-box-shadow", "0 0 3px rgba(19,105,252,3)");
                });
                $(".imgBtn").click(function () {
                    if (isShowImg == false) {
                        $(this).css('background-position', '0 -40px')
                        console.log(1)
                        isShowImg = true;
                        $(this).parent().siblings().animate({ 'height': "260px" }, 300);
                        if ($(".faceDiv").children().length == 0) {
                            for (var i = 0; i < ImgIputHandler.facePath.length; i++) {
                                $(".faceDiv").append("<img title=\"" + ImgIputHandler.facePath[i].faceName + "\" src=\"../../face/" + ImgIputHandler.facePath[i].facePath + "\" />");
                            }
                            $(".faceDiv>img").click(function () {
                                console.log(2)
                                isShowImg = false;
                                $('.imgBtn').css('background-position', '0px 0px')
                                $(this).parent().animate({ 'height': "0px" }, 300);
                                Src = "<img title=" + $(this).attr('title') + " src=" + $(this).attr('src') + ">";
                                $('.Input_text')[0].innerHTML += Src;
                            });
                        }
                    } else {
                        console.log(2)

                        isShowImg = false;
                        $(this).css('background-position', '0 0');

                        $(this).parent().siblings().animate({ 'height': "0px" }, 300);
                    }
                });
                $(".postBtn").click(function () {
                    alert($(".Input_text").val());
                });
            },
            insertAtCursor: function (myField, myValue) {
                if (document.selection) {
                    myField.focus();
                    sel = document.selection.createRange();
                    sel.text = myValue;
                    sel.select();
                } else if (myField.selectionStart || myField.selectionStart == "0") {
                    var startPos = myField.selectionStart;
                    var endPos = myField.selectionEnd;
                    var restoreTop = myField.scrollTop;
                    myField.value = myField.value.substring(0, startPos) + myValue + myField.value.substring(endPos, myField.value.length);
                    if (restoreTop > 0) {
                        myField.scrollTop = restoreTop;
                    }
                    myField.focus();
                    myField.selectionStart = startPos + myValue.length;
                    myField.selectionEnd = startPos + myValue.length;
                } else {
                    myField.value += myValue;
                    myField.focus();
                }
            }
        }
    </script>

@*<script type="text/javascript">
        //var username = document.getElementById('username').value;
        //var userid = document.getElementById('userid').value;
        //var userimg = document.getElementById('userimg').value;
        //var openid = document.getElementById('openid').value;
        //var NickName = username;
        //var NewNickIp = new NickIp(openid, username, '', true, true, '100001', '0000000001', '', '', userimg);
        var serverIP = '115.159.71.54';//服务器IP

        //var NewNickIp = new NickIp('olQmIjjUTPHrAAAQc0aeJ5LRM3qw', 'luchen', '', true, true, '100001', '0000000001', '', '', "");
        var NewNickIp = new NickIp('olQmIjkhpd5dDunhGK2H4qtapKk4', 'xiaoertu', '', true, true, '100001', '0000000001', '', '', "");
        var NickName = 'luchen';
        var userimg = '';
        //var serverIP = '192.168.1.121'; //本机测试IP

        var socket;
        var serverPort = '9000';//服务器端口
        var ChatLog = false;
        var ChatLogModal = true;

        window.onload = function () {
            connect();
        }

        function connect() {
            var host = "ws://" + serverIP + ":" + serverPort + "/"
            socket = new WebSocket(host);

            try {
                socket.onopen = function (msg) {
                    //$("btnConnect").disabled = true;
                    //alert("连接成功！");
                    socket.send(JSON.stringify(NewNickIp) + ' ');

                    var dat = new Date();
                    var str = '<div id="alertmess" class="text-center">'
                             + '<span>Hi,非常高兴为您服务~</span><br/><br/>'
                             + '<span1>' + (dat.getMonth() + 1) + '-' + dat.getDate() + ' ' + (dat.getHours().toString().length < 2 ? '0' + dat.getHours() : dat.getHours()) + ':' + (dat.getMinutes().toString().length < 2 ? '0' + dat.getMinutes() : dat.getMinutes()) + '</span1>'
                             + '</div>';
                    document.getElementById("messages").innerHTML = document.getElementById("messages").innerHTML + str;

                    var str = '<div class="media medialeft">'
                     + '<div class="media-left">'
                         + '<a href="#">'
                         + '<img class="media-object img-circle" src="../../doshinemp/Images/logo.png" alt="...">'
                         + '</a>'
                     + '</div>'
                     + '<div class="media-body">'
                         + '<div class="mediacontent" style="word-break:break-all">' + document.getElementById('welcome').value + '</div>'
                     + '</div>'
                     + '</div>';

                    var html = document.getElementById("messages").innerHTML + str;
                    document.getElementById("messages").innerHTML = html;

                };

                socket.onmessage = function (msg) {
                    if (typeof msg.data == "string") {
                        displayContent(msg.data);
                    }
                    else {
                        var str = '<div id="alertmess" class="text-center">'
                             + '<span>非文本信息！</span>'
                             + '</div>';
                        //document.getElementById("messages").innerHTML = document.getElementById("messages").innerHTML + str;
                    }
                };

                socket.onclose = function (msg) {
                    var str = '<div id="alertmess" class="text-center" style="margin-top:15px;">'
                             + '<span>连接断开！</span>'
                             + '</div>';
                    ///document.getElementById("messages").innerHTML = document.getElementById("messages").innerHTML + str;
                };
            }
            catch (ex) {
                var str = '<div id="alertmess" class="text-center">'
                             + '<span>网络错误，连接失败！</span>'
                             + '</div>';
                // document.getElementById("messages").innerHTML = document.getElementById("messages").innerHTML + str;
                log(ex);
            }
        }

        //发送消息
        function send() {
            var msg = document.getElementById('sendText').value + ' ';
            if (msg == ' ' || msg == null) {
                return;
            } else {
                if (this.ChatLog == true) {
                    NewNickIp.NickName = 'ChatLog';
                } else {
                    NewNickIp.NickName = this.NickName;
                }
                NewNickIp.Msg = msg;
                NewNickIp.IsFirst = false;
                socket.send(JSON.stringify(NewNickIp) + ' ');
                var mes = document.getElementById("messages");
                var last = mes.lastChild;
                if (last.className === 'media mediaright') {
                    var textcontent = last.firstChild.getElementsByTagName('div')[0].innerHTML;
                    textcontent = textcontent + '<br>' + msg;
                    last.firstChild.getElementsByTagName('div')[0].innerHTML = textcontent;
                } else {
                    var str = '<div class="media mediaright">'
                           + '<div class="media-body">'
                               + '<div class="pull-right mediacontent" style="word-break:break-all">' + msg + '</div>'
                           + '</div>'
                           + '<div class="media-right">'
                               + '<a href="#">'
                                   + '<img class="media-object img-circle" src="' + userimg + '" alt="...">'
                               + '</a>'
                           + '</div>'
                       + '</div>';
                    var html = document.getElementById("messages").innerHTML + str;
                    document.getElementById("messages").innerHTML = html;
                }
                var div = document.getElementById('messages');
                window.scrollTo(0, div.scrollHeight);
                document.getElementById('sendText').value = '';
            }
        }

        window.onbeforeunload = function () {
            try {
                socket.close();
                socket = null;
            }
            catch (ex) {
            }
        };

        function $(id) { return document.getElementById(id); }

        Date.prototype.Format = function (fmt) { //author: meizz
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }


        //接受消息
        function displayContent(msg) {

            var mes = document.getElementById("messages");
            var last = mes.lastChild;

            var msgsss = JSON.parse(msg);

            if (msgsss.NickName == 'ChatLog') {
                this.ChatLog = true;
            } else if (msgsss.NickName == 'NoChatLog') {
                msgsss.Msg = '客服现在为你服务。';
                this.ChatLog = false;
            }


            if (last.className === 'media medialeft') {
                var textcontent = last.lastChild.getElementsByTagName('div')[0].innerHTML;
                textcontent = textcontent + '<br>' + msgsss.Msg;
                last.lastChild.getElementsByTagName('div')[0].innerHTML = textcontent;
            } else {
                var str = '<div class="media medialeft">'
                     + '<div class="media-left">'
                         + '<a href="#">'
                         + '<img class="media-object img-circle" src="../../doshinemp/Images/logo.png" alt="...">'
                         + '</a>'
                     + '</div>'
                     + '<div class="media-body">'
                         + '<div class="mediacontent" style="word-break:break-all">' + msgsss.Msg + '</div>'
                     + '</div>'
                     + '</div>';
                var html = document.getElementById("messages").innerHTML + str;
                document.getElementById("messages").innerHTML = html;
            }

            if (msgsss.NickName == 'ChatLog' && this.ChatLogModal == true) {
                //isChatLog();
            }

            var div = document.getElementById('messages');
            window.scrollTo(0, div.scrollHeight);

        }

        function onkey(event) { if (event.keyCode == 13) { send(); } }







        document.getElementById('queren').onclick = function () {
            document.getElementById('myModal').style.display = 'none';

            var exampleInputPhone = document.getElementById('exampleInputPhone').value;
            document.getElementById('sendText').value = exampleInputPhone;

            send();


        }


        document.getElementById('quxiao').onclick = function () {
            document.getElementById('myModal').style.display = 'none';
            this.ChatLogModal = true;
        }


        function isChatLog() {
            this.ChatLogModal = false;
            setTimeout(function () {
                document.getElementById('myModal').style.display = 'block';
            }, 1000)
        }

</script>*@


}




